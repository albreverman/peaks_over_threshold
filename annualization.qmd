---
title: "Annualization"
format: html
editor: visual
---

# Clean house

```{r}
rm(list = ls())
```

# Attack packages

```{r}
library(lmom)
library(lmomco)
```

# Functions

## Madsen Annualization

Analytical conversion of Generalized Pareto distribution parameters to annualized Generalized Extreme Value distribution parameters.

Reference: Madsen, H., Rasmussen, P., & Rosbjerg, D. (1997). Comparison of annual maximum series and partial duration series methods for modeling extreme hydrologic events 1. At-site modeling. Water Resources Research, 33(4), 747-757.

```{r}
madsen_annualization <- function(gpd_par, lambda, y) {
  q0 <- unname(gpd_par["xi"])
  a <- unname(gpd_par["alpha"])
  k <- unname(gpd_par["k"])
  
  xi_ <- q0 + (a / k) * (1 - (lambda^(-k)))
  alpha_ <- a * (lambda^(-k))
  kappa_ <- k
  
  xi_ + (alpha_ / kappa_) * (1 - exp(-kappa_ * y))
  
}
```

## Gumbel Reduced Variate

-   Gumbel reduced variate from return period t (years)

-   Gumbel reduced variate from annual non-exceedance probability p

```{r}
yt <- function(t) {
  if (any(t <= 1, na.rm = TRUE)) stop("t must be > 1 (so that p in (0,1)).")
  -log(-log(1 - 1 / t))
}

rgv <- function(p) {
  if (any(p <= 0 | p >= 1, na.rm = TRUE)) stop("p must be in (0,1).")
  -log(-log(p))
}
```

# Annual non-exceedance probabilities of interest

```{r}
p <- c(0.2, 0.5, 0.8, 0.9, 0.95, 0.98, 0.99, 0.995, 0.998, 0.999)
```

# Arroyo Seco

-   Arroyo Seco at Pasadena, CA

-   15-minute flow data

-   WY 1989-2022

-   Threshold = 300 cfs

-   8 day separation

```{r}
start_year <- 1989
end_year <- 2023
numYears <- end_year - start_year + 1

pdsArroyoSeco <- c(4620, 4230, 4000, 3370, 2260, 2110, 1710, 1680, 1670, 1510, 1490, 1480, 1170, 1120, 1060, 973, 924, 921, 892, 861, 842, 802, 769, 741, 737, 705, 699, 680, 677, 613, 584, 569, 569, 532, 515, 509, 492, 484, 463, 462, 439, 439, 437, 416, 411, 402, 394, 394, 348, 329) # cfs

rate <- length(pdsArroyoSeco) / numYears
gpaParameters <- lmom::pelgpa(lmom::samlmu(pdsArroyoSeco))
gpa_para_lmomco <- list(
  type = "gpa",
  para = c(gpaParameters[["xi"]], gpaParameters[["alpha"]], gpaParameters[["k"]])
)

qt_mad <- madsen_annualization(gpaParameters, rate, rgv(p))
qt_mad

p_pds <- lmomco::f2fpds(p, rate)

ok <- is.finite(p_pds)  

qt_lang <- rep(NA_real_, length(p_pds))
qt_lang[ok] <- lmomco::quagpa(p_pds[ok], gpa_para_lmomco)
```

# Orestimba Creek

-   Mean daily flow

-   WY 1933-2023

-   Threshold = 650 cfs

-   10 day separation

```{r}

start_year <- 1933
end_year <- 2023
numYears <- end_year - start_year + 1
pdsOrestimbaCr <- c(4550, 4260, 3610, 3170, 3010, 2790, 2720, 2560, 2550, 2460, 2370, 2210, 2190, 2090, 2060, 1990, 1940, 1930, 1930, 1890, 1780, 1770, 1740, 1740, 1660, 1580, 1570, 1570, 1530, 1520, 1510, 1460, 1450, 1420, 1400, 1330, 1280, 1260, 1240, 1230, 1190, 1170, 1170, 1160, 1150, 1130, 1090, 1080, 1070, 1070, 1050, 1040, 994, 969, 952, 935, 930, 914, 904, 895, 893, 873, 856, 810, 805, 774, 774, 768, 732, 709, 697, 686, 677, 664) # cfs

rate <- length(pdsOrestimbaCr) / numYears
gpaParameters <- lmom::pelgpa(lmom::samlmu(pdsOrestimbaCr))
gpa_para_lmomco <- list(
  type = "gpa",
  para = c(gpaParameters[["xi"]], gpaParameters[["alpha"]], gpaParameters[["k"]])
)

qt_mad <- madsen_annualization(gpaParameters, rate, rgv(p))
qt_mad

p_pds <- lmomco::f2fpds(p, rate)

ok <- is.finite(p_pds)  

qt_lang <- rep(NA_real_, length(p_pds))
qt_lang[ok] <- lmomco::quagpa(p_pds[ok], gpa_para_lmomco)
```
