---
title: "DiagnosticData"
format: html
editor: visual
---

# Clean house

```{r}
rm(list = ls())
```

# Attack packages

```{r}
install.packages("evmix")
library(evmix)
library(lmom)
```

# Functions

## Anderson-Darling Right Tail Weighted Test Statistic

References:

-   Sinclair, C. D., B. D. Spurr, and M. I. Ahmad (1990), Modified Anderson Darling test, Commun. Stat. Theory Methods, 19(10), 3677–3686, doi:10.1080/03610929008830405.

-   Solari, S., M. Eg€uen, M. J. Polo, and M. A. Losada (2017), Peaks Over Threshold (POT): A methodology for automatic threshold estimation using goodness of fit p-value, Water Resour.Res., 53, 2833–2849, doi:10.1002/2016WR019426.

```{r}
anderson_darling_right_tail_weigted_gpa <- function(pds, gpa_parameters) {
  n <- length(pds)
  sum <- 0
  pds_sorted <- sort(pds)
  z <- cdfgpa(pds_sorted, para = gpa_parameters)
  summand <- numeric(length = n)
  
  for(i in seq(n)) {
    summand[i] <- (2 - ((2 * i - 1)/n)) * log(1 - z[i]) + 2 * z[i]
  }
  
  return ((n/2) - cumsum(summand)[n])
}
```

# Fort Collins Precipitation

-   Daily precipitation (in) at Fort Collins, CO

-   CY 1893 - 2023

-   Threshold = 1.5 in

-   5 day time separation between peaks

-   <https://climate.colostate.edu/data_access_new.ht>

```{r}
threshold <- 1.5 # inches
start_year <- 1893
end_year <- 2023

pds_fc_precip <- c(
  2.18, 1.63, 1.74, 1.52, 2.39, 1.59, 2.32, 4.34, 3.02,
  1.74, 1.60, 1.86, 1.93, 1.68, 1.75, 1.50, 1.83, 2.23, 2.82,
  1.65, 2.30, 2.05, 1.70, 1.56, 1.89, 1.93, 1.76, 3.54, 1.60,
  1.81, 1.99, 2.19, 2.23, 2.15, 1.76, 3.54, 1.76, 2.13,
  1.84, 2.18, 1.50, 1.76, 1.61, 3.21, 1.69, 1.58, 2.58,
  2.69, 2.71, 1.74, 1.51, 2.27, 1.62, 2.85, 2.15, 2.05,
  4.43, 1.85, 1.56, 1.52, 3.17, 1.52, 1.71, 1.55, 1.87,
  2.03, 1.62, 3.48, 1.83, 1.98, 1.54, 1.81, 2.11, 4.63,
  2.26, 1.75, 1.76, 2.41, 1.63, 3.30, 1.63, 2.49, 1.50, 2.19,
  1.75, 1.55, 1.70, 2.10, 1.92, 1.51, 1.99, 1.97, 1.62, 1.55,
  2.77, 1.74, 1.78, 1.97, 1.98, 2.45) # inches


gpa_parameters <- lmom::pelgpa(lmom::samlmu(pds_fc_precip))

gpa_para_lmomco <- list(
  type = "gpa",
  para = c(gpa_parameters[["xi"]], gpa_parameters[["alpha"]], gpa_parameters[["k"]])
)

num_exceedances <- length(pds_fc_precip)
num_years <- end_year - start_year + 1
rate_exceedances <- num_exceedances/num_years

mean_excess <- mean(pds_fc_precip - threshold)
ad_rtw_test_stat <- anderson_darling_right_tail_weigted_gpa(pds_fc_precip, gpa_para_lmomco)

summary_tbl <- data.frame(
  num_years         = num_years,
  num_exceedances   = num_exceedances,
  rate_exceedances  = rate_exceedances,
  threshold         = threshold,
  mean_excess       = mean_excess,
  gpa_shape         = unname(gpa_parameters["k"]),
  ad_rtw_test_stat  = ad_rtw_test_stat,
  row.names = NULL
)

summary_2col <- data.frame(
  label = names(summary_tbl),
  value = unname(as.numeric(summary_tbl[1, ])),
  row.names = NULL
)

summary_2col
```

# Apple River

-   Mean daily streamflow (cfs) Apple River near Hanover, IL

-   CY 1935-2023

-   Threshold = 1250 cfs

-   11 day time separation between peaks

-   250 cfs magnitude differential

```{r}
threshold <- 1250 # cfs
start_year <- 1935
end_year <- 2023

pds_apple_river_flow <- c(2080, 	1500, 	2140, 	2380, 	9010, 	3650, 	3000, 	
                          6560, 	2510, 	1950, 	3330, 	1300, 	1590, 	1700, 	
                          2360, 	3010, 	1260, 	2000, 	5500, 	1260, 	2020, 	
                          2180, 	1820, 	2360, 	1730, 	2830, 	3110, 	6750, 	
                          3740, 	1460, 	1410, 	1430, 	3910, 	6700, 	5730, 	
                          2580, 	2000, 	3290, 	1840, 	3100, 	3000, 	1370, 	
                          1750, 	2220, 	1810, 	3070, 	4370, 	2000, 	6900, 	
                          3560, 	2430, 	2030, 	2470, 	1600, 	6630, 	1700, 	
                          1370, 	6200, 	1300, 	2100, 	1350, 	1310, 	2330, 	
                          2400, 	4300, 	2090, 	1280, 	1320, 	1930, 	6770, 	
                          8610, 	2200, 	1590, 	2040, 	3870, 	3470, 	2200, 	
                          2100, 	1670, 	1510, 	1630, 	1780, 	3000, 	2650, 	
                          1360, 	7020, 	5400, 	1260, 	1300, 	2260, 	1510, 	
                          3600, 	1300, 	2380, 	2870, 	1500, 	1860, 	6000, 	
                          1700, 	2480, 	1690, 	4390, 	2380, 	6000, 	2270, 	
                          1600, 	7900, 	3950, 	1530, 	1580, 	6960, 	7230, 	
                          1790, 	3240, 	1660, 	2020, 	4500, 	3060, 	1700, 	
                          2000, 	1440, 	2010, 	2500, 	3200, 	2000, 	2980, 	
                          4060, 	1920, 	4500, 	1480, 	2700, 	1270, 	2630, 	
                          2400, 	4310, 	1280, 	7170, 	1690, 	2140, 	1260, 	
                          3910, 	1310, 	3930, 	2300, 	5320, 	1320, 	4070, 	
                          1470, 	2340, 	2710, 	1680, 	2950, 	2320, 	3560, 	
                          2670, 	5180, 	7450, 	1410, 	2400, 	2400, 	2000, 	
                          3450, 	3560, 	1280, 	1260, 	3730, 	1970, 	1990, 	
                          1780, 	1640, 	1670, 	9470, 	9440, 	1640, 	3920, 	
                          2970, 	1310, 	2300, 	1560, 	1380, 	3270, 	1420, 	
                          1780, 	2790, 	2820, 	10100, 	1910, 	2040, 	3230, 	
                          1540, 	1480, 	4970, 	2310, 	1800, 	3500, 	2140, 	
                          5280, 	1850, 	13000, 	2110, 	1450, 	15000, 	1420, 	
                          4510, 	5590, 	3360, 	2320, 	1630, 	1580, 	4080, 
                          4930, 	2230, 	3010, 	1510, 	1690, 	1360, 	1410, 	
                          2970, 	15200, 	8090, 	1680, 	2060, 	1270, 	5850, 	
                          1600, 	2830, 	6320, 	7540, 	1350, 	1520, 	3140, 	
                          3300, 	3720) # cfs

gpa_parameters <- evmix::fgpd(pds_apple_river_flow, threshold)

# gpa_para_lmomco <- list(
#   type = "gpa",
#   para = c(gpa_parameters[["xi"]], gpa_parameters[["alpha"]], gpa_parameters[["k"]])
# )

num_exceedances <- length(pds_apple_river_flow)
num_years <- end_year - start_year + 1
rate_exceedances <- num_exceedances/num_years


mean_excess <- mean(pds_apple_river_flow - threshold)
ad_rtw_test_stat <- anderson_darling_right_tail_weigted_gpa(pds_apple_river_flow, gpa_parameters)

summary_tbl <- data.frame(
  num_years         = num_years,
  num_exceedances   = num_exceedances,
  rate_exceedances  = rate_exceedances,
  threshold         = threshold,
  mean_excess       = mean_excess,
  gpa_shape         = unname(gpa_parameters["k"]),
  ad_rtw_test_stat  = ad_rtw_test_stat,
  row.names = NULL
)

summary_2col <- data.frame(
  label = names(summary_tbl),
  value = unname(as.numeric(summary_tbl[1, ])),
  row.names = NULL
)

summary_2col
```
